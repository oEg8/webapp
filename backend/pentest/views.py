import json
from django.http import JsonResponse, HttpResponseBadRequest, HttpResponseNotAllowed
from django.views.decorators.csrf import csrf_exempt

from .models import PentestRequest


OFFERINGS = [
    {"id": "web", "name": "Web Application Pentest", "description": "OWASP-based review of web applications."},
    {"id": "api", "name": "API Security Review", "description": "Authentication, authorization, and input validation coverage."},
    {"id": "cloud", "name": "Cloud Configuration Review", "description": "Best-practice review of cloud accounts and IAM posture."},
]


def offerings(request):
    if request.method != "GET":
        return HttpResponseNotAllowed(["GET"])
    return JsonResponse({"offerings": OFFERINGS})


@csrf_exempt
def requests_list(request):
    if request.method == "GET":
        data = [req.as_dict() for req in PentestRequest.objects.all()]
        return JsonResponse({"requests": data})

    if request.method == "POST":
        try:
            payload = json.loads(request.body.decode("utf-8"))
        except json.JSONDecodeError:
            return HttpResponseBadRequest("Invalid JSON")

        required_fields = ["client_name", "contact_email", "scope"]
        if any(not payload.get(field) for field in required_fields):
            return HttpResponseBadRequest("client_name, contact_email, and scope are required.")

        pentest_request = PentestRequest.objects.create(
            client_name=payload["client_name"],
            contact_email=payload["contact_email"],
            scope=payload["scope"],
            preferred_window=payload.get("preferred_window", ""),
        )
        return JsonResponse(pentest_request.as_dict(), status=201)

    return HttpResponseNotAllowed(["GET", "POST"])


@csrf_exempt
def request_detail(request, pk):
    try:
        pentest_request = PentestRequest.objects.get(pk=pk)
    except PentestRequest.DoesNotExist:
        return JsonResponse({"error": "Not found"}, status=404)

    if request.method == "GET":
        return JsonResponse(pentest_request.as_dict())

    if request.method in {"PATCH", "PUT"}:
        try:
            payload = json.loads(request.body.decode("utf-8"))
        except json.JSONDecodeError:
            return HttpResponseBadRequest("Invalid JSON")

        if "status" in payload:
            pentest_request.status = payload["status"]
        if "preferred_window" in payload:
            pentest_request.preferred_window = payload["preferred_window"]
        pentest_request.save()
        return JsonResponse(pentest_request.as_dict())

    return HttpResponseNotAllowed(["GET", "PATCH", "PUT"])
